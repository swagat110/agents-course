<CourseFloatingBanner 
  classNames="absolute z-10 right-0 top-0"
  notebooks={[
    {label: "Google Colab", value: "https://colab.research.google.com/#fileId=https://huggingface.co/agents-course/notebooks/blob/main/unit2/smolagents/retrieval_agents.ipynb"},
]}
askForHelpUrl="http://hf.co/join/discord" />

# ì—ì´ì „í‹± RAG ì‹œìŠ¤í…œ êµ¬ì¶•í•˜ê¸°

<Tip>
ì½”ë“œëŠ” <a href="https://huggingface.co/agents-course/notebooks/blob/main/unit2/smolagents/retrieval_agents.ipynb" target="_blank">ì´ ë…¸íŠ¸ë¶</a>ì—ì„œ ë”°ë¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Google Colabì—ì„œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
</Tip>

Retrieval Augmented Generation(RAG) ì‹œìŠ¤í…œì€ ë°ì´í„° ê²€ìƒ‰ê³¼ ìƒì„± ëª¨ë¸ì˜ ëŠ¥ë ¥ì„ ê²°í•©í•˜ì—¬ ìƒí™©ì— ë§ëŠ” ë‹µë³€ì„ ì œê³µí•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì‚¬ìš©ìì˜ ì§ˆë¬¸ì´ ê²€ìƒ‰ ì—”ì§„ì— ì „ë‹¬ë˜ê³ , ê²€ìƒ‰ëœ ê²°ê³¼ê°€ ì§ˆë¬¸ê³¼ í•¨ê»˜ ëª¨ë¸ì— ì œê³µë©ë‹ˆë‹¤. ëª¨ë¸ì€ ì§ˆë¬¸ê³¼ ê²€ìƒ‰ëœ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤.

ì—ì´ì „í‹± RAG(ê²€ìƒ‰ ì¦ê°• ìƒì„±)ëŠ” **ììœ¨ ì—ì´ì „íŠ¸ì™€ ë™ì  ì§€ì‹ ê²€ìƒ‰**ì„ ê²°í•©í•˜ì—¬ ê¸°ì¡´ RAG ì‹œìŠ¤í…œì„ í™•ì¥í•©ë‹ˆë‹¤.

ê¸°ì¡´ RAG ì‹œìŠ¤í…œì€ LLMì´ ê²€ìƒ‰ëœ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹µë³€ì„ ìƒì„±í•˜ì§€ë§Œ, ì—ì´ì „í‹± RAGëŠ” **ê²€ìƒ‰ê³¼ ìƒì„± ê³¼ì •ì„ ì§€ëŠ¥ì ìœ¼ë¡œ ì œì–´**í•˜ì—¬ íš¨ìœ¨ì„±ê³¼ ì •í™•ì„±ì„ ë†’ì…ë‹ˆë‹¤.

ê¸°ì¡´ RAG ì‹œìŠ¤í…œì˜ ì£¼ìš” í•œê³„ëŠ” **ë‹¨ì¼ ê²€ìƒ‰ ë‹¨ê³„ì— ì˜ì¡´**í•˜ê³ , ì‚¬ìš©ìì˜ ì§ˆë¬¸ê³¼ ì§ì ‘ì ì¸ ì˜ë¯¸ì  ìœ ì‚¬ì„±ì—ë§Œ ì§‘ì¤‘í•˜ì—¬ ê´€ë ¨ ì •ë³´ë¥¼ ë†“ì¹  ìˆ˜ ìˆë‹¤ëŠ” ì ì…ë‹ˆë‹¤.

ì—ì´ì „í‹± RAGëŠ” ì—ì´ì „íŠ¸ê°€ ê²€ìƒ‰ ì¿¼ë¦¬ë¥¼ ììœ¨ì ìœ¼ë¡œ ìƒì„±í•˜ê³ , ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë¹„íŒì ìœ¼ë¡œ í‰ê°€í•˜ë©°, ì—¬ëŸ¬ ë²ˆì˜ ê²€ìƒ‰ ë‹¨ê³„ë¥¼ ê±°ì³ ë” ë§ì¶¤í™”ë˜ê³  í¬ê´„ì ì¸ ì¶œë ¥ì„ ìƒì„±í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.

## DuckDuckGoë¥¼ í™œìš©í•œ ê¸°ë³¸ ê²€ìƒ‰

ì´ì œ DuckDuckGoë¥¼ ì‚¬ìš©í•´ ì›¹ì„ ê²€ìƒ‰í•˜ëŠ” ê°„ë‹¨í•œ ì—ì´ì „íŠ¸ë¥¼ ë§Œë“¤ì–´ë´…ì‹œë‹¤. ì´ ì—ì´ì „íŠ¸ëŠ” ì •ë³´ë¥¼ ê²€ìƒ‰í•˜ê³ , ë‹µë³€ì„ ì¢…í•©í•˜ì—¬ ì§ˆë¬¸ì— ë‹µí•©ë‹ˆë‹¤. ì—ì´ì „í‹± RAGë¥¼ í™œìš©í•˜ë©´ Alfredì˜ ì—ì´ì „íŠ¸ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì¼ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* ìµœì‹  ìŠˆí¼íˆì–´ë¡œ íŒŒí‹° íŠ¸ë Œë“œ ê²€ìƒ‰
* ê²°ê³¼ë¥¼ ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ìš”ì†Œë¡œ ì„¸ë¶„í™”
* ì •ë³´ë¥¼ ì¢…í•©í•˜ì—¬ ì™„ì„±ëœ ê³„íš ì œì•ˆ

Alfredì˜ ì—ì´ì „íŠ¸ê°€ ì´ë¥¼ ì–´ë–»ê²Œ ìˆ˜í–‰í•˜ëŠ”ì§€ ì‚´í´ë´…ì‹œë‹¤:

```python
from smolagents import CodeAgent, DuckDuckGoSearchTool, InferenceClientModel

# ê²€ìƒ‰ ë„êµ¬ ì´ˆê¸°í™”
search_tool = DuckDuckGoSearchTool()

# ëª¨ë¸ ì´ˆê¸°í™”
model = InferenceClientModel()

agent = CodeAgent(
    model=model,
    tools=[search_tool],
)

# ì˜ˆì‹œ ì‚¬ìš©ë²•
response = agent.run(
    "Search for luxury superhero-themed party ideas, including decorations, entertainment, and catering."
)
print(response)
```

ì—ì´ì „íŠ¸ì˜ ë™ì‘ ê³¼ì •:

1. **ìš”ì²­ ë¶„ì„:** Alfredì˜ ì—ì´ì „íŠ¸ëŠ” ì¿¼ë¦¬ì˜ í•µì‹¬ ìš”ì†Œ(ê³ ê¸‰ ìŠˆí¼íˆì–´ë¡œ í…Œë§ˆ íŒŒí‹°, ì¥ì‹, ì—”í„°í…Œì¸ë¨¼íŠ¸, ì¼€ì´í„°ë§ ë“±)ë¥¼ íŒŒì•…í•©ë‹ˆë‹¤.
2. **ê²€ìƒ‰ ìˆ˜í–‰:** DuckDuckGoë¥¼ í™œìš©í•´ Alfredì˜ ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ì·¨í–¥ì— ë§ëŠ” ìµœì‹  ì •ë³´ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.
3. **ì •ë³´ ì¢…í•©:** ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ íŒŒí‹°ì˜ ëª¨ë“  ì¸¡ë©´ì„ ì•„ìš°ë¥´ëŠ” ì‹¤í–‰ ê°€ëŠ¥í•œ ê³„íšì„ ë§Œë“­ë‹ˆë‹¤.
4. **ì •ë³´ ì €ì¥:** ê²€ìƒ‰ëœ ì •ë³´ë¥¼ ì €ì¥í•´, ì´í›„ íŒŒí‹° ì¤€ë¹„ ì‹œ íš¨ìœ¨ì ìœ¼ë¡œ ì¬í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ë§ì¶¤í˜• ì§€ì‹ ë² ì´ìŠ¤ ë„êµ¬

íŠ¹ì • ì‘ì—…ì—ëŠ” ë§ì¶¤í˜• ì§€ì‹ ë² ì´ìŠ¤ê°€ ë§¤ìš° ìœ ìš©í•©ë‹ˆë‹¤. ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ëœ ê¸°ìˆ  ë¬¸ì„œë‚˜ ì „ë¬¸ ì§€ì‹ì„ ì¿¼ë¦¬í•˜ëŠ” ë„êµ¬ë¥¼ ë§Œë“¤ì–´ë´…ì‹œë‹¤. ì˜ë¯¸ì  ê²€ìƒ‰ì„ í†µí•´ Alfredì˜ ìš”êµ¬ì— ê°€ì¥ ì í•©í•œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤ëŠ” í…ìŠ¤íŠ¸ë‚˜ ê¸°íƒ€ ë°ì´í„°ë¥¼ ë¨¸ì‹ ëŸ¬ë‹ ëª¨ë¸ë¡œ ì„ë² ë”©(ìˆ«ì ë²¡í„°)í•˜ì—¬ ì €ì¥í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì˜ë¯¸ì ìœ¼ë¡œ ìœ ì‚¬í•œ ì •ë³´ë¥¼ ê³ ì°¨ì› ê³µê°„ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ ì ‘ê·¼ë²•ì€ ì‚¬ì „ ì •ì˜ëœ ì§€ì‹ê³¼ ì˜ë¯¸ì  ê²€ìƒ‰ì„ ê²°í•©í•´ ìƒí™©ì— ë§ëŠ” ì†”ë£¨ì…˜ì„ ì œê³µí•©ë‹ˆë‹¤. AlfredëŠ” ì „ë¬¸ ì§€ì‹ì— ì ‘ê·¼í•´ íŒŒí‹°ì˜ ëª¨ë“  ì„¸ë¶€ ì‚¬í•­ì„ ì™„ë²½í•˜ê²Œ ì¤€ë¹„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì•„ë˜ ì˜ˆì‹œì—ì„œëŠ” BM25 ê²€ìƒ‰ê¸°ë¥¼ ì‚¬ìš©í•´ ë§ì¶¤í˜• ì§€ì‹ ë² ì´ìŠ¤ì—ì„œ íŒŒí‹° ì•„ì´ë””ì–´ë¥¼ ê²€ìƒ‰í•˜ëŠ” ë„êµ¬ë¥¼ ë§Œë“­ë‹ˆë‹¤. `RecursiveCharacterTextSplitter`ë¡œ ë¬¸ì„œë¥¼ ì‘ì€ ì²­í¬ë¡œ ë‚˜ëˆ  ê²€ìƒ‰ íš¨ìœ¨ì„ ë†’ì…ë‹ˆë‹¤.

```python
from langchain.docstore.document import Document
from langchain.text_splitter import RecursiveCharacterTextSplitter
from smolagents import Tool
from langchain_community.retrievers import BM25Retriever
from smolagents import CodeAgent, InferenceClientModel

class PartyPlanningRetrieverTool(Tool):
    name = "party_planning_retriever"
    description = "Alfredì˜ ìŠˆí¼íˆì–´ë¡œ í…Œë§ˆ íŒŒí‹°ë¥¼ ìœ„í•œ ì•„ì´ë””ì–´ë¥¼ ì˜ë¯¸ì  ê²€ìƒ‰ìœ¼ë¡œ ì°¾ì•„ì¤ë‹ˆë‹¤."
    inputs = {
        "query": {
            "type": "string",
            "description": "íŒŒí‹° ì¤€ë¹„ë‚˜ ìŠˆí¼íˆì–´ë¡œ í…Œë§ˆì™€ ê´€ë ¨ëœ ì¿¼ë¦¬ì…ë‹ˆë‹¤.",
        }
    }
    output_type = "string"

    def __init__(self, docs, **kwargs):
        super().__init__(**kwargs)
        self.retriever = BM25Retriever.from_documents(
            docs, k=5  # ìƒìœ„ 5ê°œ ë¬¸ì„œ ê²€ìƒ‰
        )

    def forward(self, query: str) -> str:
        assert isinstance(query, str), "ê²€ìƒ‰ ì¿¼ë¦¬ëŠ” ë¬¸ìì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤."

        docs = self.retriever.invoke(
            query,
        )
        return "\nê²€ìƒ‰ëœ ì•„ì´ë””ì–´:\n" + "".join(
            [
                f"\n\n===== ì•„ì´ë””ì–´ {str(i)} =====\n" + doc.page_content
                for i, doc in enumerate(docs)
            ]
        )

# íŒŒí‹° ì¤€ë¹„ì— ê´€í•œ ì§€ì‹ ë² ì´ìŠ¤ ì˜ˆì‹œ
party_ideas = [
    {"text": "ê³ ê¸‰ ì¥ì‹(ê¸ˆìƒ‰ ì¥ì‹, ë²¨ë²³ ì»¤íŠ¼ ë“±)ì´ ìˆëŠ” ìŠˆí¼íˆì–´ë¡œ í…Œë§ˆ ê°€ë©´ë¬´ë„íšŒ.", "source": "Party Ideas 1"},
    {"text": "ë°°íŠ¸ë§¨, ì›ë”ìš°ë¨¼ ë“± ìŠˆí¼íˆì–´ë¡œ í…Œë§ˆ ìŒì•…ì„ ì—°ì£¼í•  ì „ë¬¸ DJ ê³ ìš©.", "source": "Entertainment Ideas"},
    {"text": "ì¼€ì´í„°ë§ ë©”ë‰´ì— ìŠˆí¼íˆì–´ë¡œ ì´ë¦„ì„ ë¶™ì¸ ìš”ë¦¬ ì œê³µ(ì˜ˆ: 'í—í¬ì˜ ê·¸ë¦° ìŠ¤ë¬´ë””', 'ì•„ì´ì–¸ë§¨ì˜ íŒŒì›Œ ìŠ¤í…Œì´í¬').", "source": "Catering Ideas"},
    {"text": "ì¥ì†Œ ê³³ê³³ì— ìŠˆí¼íˆì–´ë¡œ ë¡œê³ ì™€ ê³ ë‹´ ë“± ë„ì‹œ í”„ë¡œì ì…˜ ì¥ì‹.", "source": "Decoration Ideas"},
    {"text": "VRì„ í™œìš©í•œ ìŠˆí¼íˆì–´ë¡œ ì‹œë®¬ë ˆì´ì…˜, í…Œë§ˆ ê²Œì„ ë“± ì¸í„°ë™í‹°ë¸Œ ì²´í—˜ ì œê³µ.", "source": "Entertainment Ideas"}
]

source_docs = [
    Document(page_content=doc["text"], metadata={"source": doc["source"]})
    for doc in party_ideas
]

# ë¬¸ì„œë¥¼ ì‘ì€ ì²­í¬ë¡œ ë¶„í• 
text_splitter = RecursiveCharacterTextSplitter(
    chunk_size=500,
    chunk_overlap=50,
    add_start_index=True,
    strip_whitespace=True,
    separators=["\n\n", "\n", ".", " ", ""],
)
docs_processed = text_splitter.split_documents(source_docs)

# ê²€ìƒ‰ ë„êµ¬ ìƒì„±
party_planning_retriever = PartyPlanningRetrieverTool(docs_processed)

# ì—ì´ì „íŠ¸ ì´ˆê¸°í™”
agent = CodeAgent(tools=[party_planning_retriever], model=InferenceClientModel())

# ì˜ˆì‹œ ì‚¬ìš©ë²•
response = agent.run(
    "Find ideas for a luxury superhero-themed party, including entertainment, catering, and decoration options."
)

print(response)
```

ì´ í–¥ìƒëœ ì—ì´ì „íŠ¸ëŠ” ë‹¤ìŒì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
1. ë¨¼ì € ë¬¸ì„œì—ì„œ ê´€ë ¨ ì •ë³´ ê²€ìƒ‰
2. ì§€ì‹ ë² ì´ìŠ¤ì˜ ì¸ì‚¬ì´íŠ¸ ê²°í•©
3. ëŒ€í™” ë§¥ë½ì„ ë©”ëª¨ë¦¬ì— ìœ ì§€

## ê³ ë„í™”ëœ ê²€ìƒ‰ ê¸°ëŠ¥

ì—ì´ì „í‹± RAG ì‹œìŠ¤í…œì„ êµ¬ì¶•í•  ë•Œ, ì—ì´ì „íŠ¸ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ê³ ê¸‰ ì „ëµì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

1. **ì¿¼ë¦¬ ì¬êµ¬ì„±(Query Reformulation):** ì›ë³¸ ì¿¼ë¦¬ ëŒ€ì‹ , ë¬¸ì„œì— ë” ì˜ ë§ëŠ” ìµœì í™”ëœ ê²€ìƒ‰ì–´ ìƒì„±
2. **ì¿¼ë¦¬ ë¶„í•´(Query Decomposition):** ì—¬ëŸ¬ ì •ë³´ë¥¼ í¬í•¨í•œ ì¿¼ë¦¬ë¥¼ ë¶„í•´í•´ ê°ê° ê²€ìƒ‰
3. **ì¿¼ë¦¬ í™•ì¥(Query Expansion):** ì¿¼ë¦¬ë¥¼ ë‹¤ì–‘í•œ í‘œí˜„ìœ¼ë¡œ í™•ì¥í•´ ì—¬ëŸ¬ ë°©ì‹ìœ¼ë¡œ ê²€ìƒ‰
4. **ì¬ì •ë ¬(Reranking):** Cross-Encoder ë“±ìœ¼ë¡œ ê²€ìƒ‰ ê²°ê³¼ì™€ ì¿¼ë¦¬ì˜ ì˜ë¯¸ì  ê´€ë ¨ì„± ì ìˆ˜ ë¶€ì—¬
5. **ë‹¤ë‹¨ê³„ ê²€ìƒ‰(Multi-Step Retrieval):** ì´ˆê¸° ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¶”ê°€ ê²€ìƒ‰ ë°˜ë³µ
6. **ì†ŒìŠ¤ í†µí•©(Source Integration):** ì›¹ ê²€ìƒ‰, ë¡œì»¬ ë¬¸ì„œ ë“± ë‹¤ì–‘í•œ ì†ŒìŠ¤ ê²°í•©
7. **ê²°ê³¼ ê²€ì¦(Result Validation):** ê²€ìƒ‰ëœ ë‚´ìš©ì˜ ì í•©ì„±ê³¼ ì •í™•ì„± í‰ê°€ í›„ ë‹µë³€ì— í¬í•¨

íš¨ê³¼ì ì¸ ì—ì´ì „í‹± RAG ì‹œìŠ¤í…œì„ ìœ„í•´ì„œëŠ” ì—¬ëŸ¬ ì¸¡ë©´ì„ ì‹ ì¤‘íˆ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤. ì—ì´ì „íŠ¸ëŠ” **ì¿¼ë¦¬ ìœ í˜•ê³¼ ë§¥ë½ì— ë”°ë¼ ì ì ˆí•œ ë„êµ¬ë¥¼ ì„ íƒ**í•´ì•¼ í•˜ë©°, ë©”ëª¨ë¦¬ ì‹œìŠ¤í…œì„ í†µí•´ ëŒ€í™” ì´ë ¥ì„ ê´€ë¦¬í•˜ê³  ì¤‘ë³µ ê²€ìƒ‰ì„ ë°©ì§€í•´ì•¼ í•©ë‹ˆë‹¤. ë˜í•œ, ì˜ˆë¹„ ì „ëµì„ ë§ˆë ¨í•´ ì£¼ìš” ê²€ìƒ‰ ë°©ë²•ì´ ì‹¤íŒ¨í•´ë„ ê°€ì¹˜ë¥¼ ì œê³µí•  ìˆ˜ ìˆì–´ì•¼ í•˜ë©°, ê²€ì¦ ë‹¨ê³„ë¥¼ í†µí•´ ê²€ìƒ‰ ê²°ê³¼ì˜ ì •í™•ì„±ê³¼ ì í•©ì„±ì„ ë³´ì¥í•´ì•¼ í•©ë‹ˆë‹¤.

## ì°¸ê³  ìë£Œ

- [Agentic RAG: turbocharge your RAG with query reformulation and self-query! ğŸš€](https://huggingface.co/learn/cookbook/agent_rag) - smolagentsë¡œ ì—ì´ì „í‹± RAG ì‹œìŠ¤í…œì„ ê°œë°œí•˜ëŠ” ë ˆì‹œí”¼
